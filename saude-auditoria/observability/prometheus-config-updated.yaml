apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: saude-auditoria-gateway
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s
      external_labels:
        cluster: 'sesapi-prod-viver'
        namespace: 'saude-auditoria-gateway'

    scrape_configs:
      # Consumer Python (métricas de processamento)
      - job_name: 'auditoria-consumer'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - saude-auditoria-gateway
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            action: keep
            regex: auditoria-consumer
          - source_labels: [__meta_kubernetes_pod_ip]
            action: replace
            target_label: __address__
            replacement: ${1}:8000

      # API FastAPI
      - job_name: 'auditoria-api'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - saude-auditoria-gateway
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            action: keep
            regex: saude-auditoria-api
          - source_labels: [__meta_kubernetes_pod_ip]
            action: replace
            target_label: __address__
            replacement: ${1}:8000

      # Gateway Go
      - job_name: 'auditoria-gateway'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - saude-auditoria-gateway
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            action: keep
            regex: saude-auditoria-gateway
          - source_labels: [__meta_kubernetes_pod_ip]
            action: replace
            target_label: __address__
            replacement: ${1}:8080

      # Kafka JMX Exporter
      - job_name: 'kafka'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - saude-auditoria-gateway
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            action: keep
            regex: kafka
          - source_labels: [__meta_kubernetes_pod_ip]
            action: replace
            target_label: __address__
            replacement: ${1}:5556

      # ClickHouse
      - job_name: 'clickhouse'
        static_configs:
          - targets: ['clickhouse.saude-auditoria-gateway.svc.cluster.local:8123']

      # Redis
      - job_name: 'redis'
        static_configs:
          - targets: ['redis.saude-auditoria-gateway.svc.cluster.local:6379']

      # Usuários Online Exporter (consulta API e expõe métricas)
      - job_name: 'usuarios-online-exporter'
        static_configs:
          - targets: ['usuarios-online-exporter.saude-auditoria-gateway.svc.cluster.local:9091']
