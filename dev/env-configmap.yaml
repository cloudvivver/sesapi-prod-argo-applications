apiVersion: v1
kind: ConfigMap
metadata:
  name: env
  namespace: dev
  labels:
    app: dev
    environment: production
data:
  # Application URLs
  RAILS_ENV: production
  APP_BASE_URL: https://dev.saude.pi.gov.br
  APP_HOST: dev.saude.pi.gov.br

  # Redis Configuration
  REDIS_HOST: redis
  REDIS_PORT: "6379"
  REDIS_DB: "0"
  REDIS_MAXMEMORY_POLICY: "allkeys-lfu"
  REDIS_TIMEOUT: "1"

  # Database Configuration (AWS RDS via Proxy)
  DATABASE_HOST: proxy-db-viverdb.proxy-cb8m6qcy2cyh.sa-east-1.rds.amazonaws.com
  DATABASE_PORT: "5432"
  DATABASE_PROD: cuidar_isac_pi
  DATABASE_BI_SESAPI: ""

  # Database Connection Pool (optimized for RDS Proxy)
  DATABASE_POOL: "20"
  DATABASE_TIMEOUT: "5000"
  DATABASE_CHECKOUT_TIMEOUT: "120000"
  DATABASE_REAPING_FREQUENCY: "60"
  DATABASE_STATEMENT_LIMIT: "1000"
  DATABASE_INCLUDES_CACHE: "enabled"

  # Database SSL/TLS (required by RDS Proxy)
  DATABASE_SSLMODE: "require"

  # Rails Application Settings
  # Fase 1 (Conservador): Aguardar estabilização da migração
  # Fase 2 (após 1 semana estável): RAILS_MAX_THREADS: "8", SIDEKIQ_CONCURRENCY: "25"
  RAILS_MAX_THREADS: "6"
  WEB_CONCURRENCY: "2"
  SIDEKIQ_CONCURRENCY: "5"
  RAILS_SERVE_STATIC_FILES: "true"
  RAILS_STATIC_CACHE_CONTROL: "public, max-age=31536000, immutable"

  # Ruby Garbage Collection Optimization (Rails 6.1 + Ruby 3.0.6)
  # Configurações otimizadas para reduzir fragmentação de memória
  RUBY_GC_HEAP_GROWTH_FACTOR: "1.1"              # Crescimento controlado da heap
  RUBY_GC_HEAP_INIT_SLOTS: "400000"              # Slots iniciais (reduz alocações no boot)
  RUBY_GC_HEAP_FREE_SLOTS: "200000"              # Slots livres após GC (era 40000)
  RUBY_GC_HEAP_OLDOBJECT_LIMIT_FACTOR: "1.3"    # Controle de objetos antigos
  RUBY_GC_HEAP_GROWTH_MAX_SLOTS: "100000"       # Limite de crescimento por vez
  RUBY_GC_MALLOC_LIMIT: "16000000"              # 16MB - limite antes de GC
  RUBY_GC_MALLOC_LIMIT_MAX: "32000000"          # 32MB - limite máximo de malloc
  MALLOC_ARENA_MAX: "2"                          # Reduz fragmentação glibc

  # Rails Cache Optimizations
  RAILS_ACTION_CACHE: "true"
  RAILS_FRAGMENT_CACHE: "true"
  RAILS_CACHE_STORE: "configured"
  RAILS_CACHE_EXPIRES_IN: "configured"
  RAILS_DESKTOP_CACHE_TTL: "configured"

  # Build Configuration
  BUNDLE_JOBS: "4"
  BUNDLE_RETRY: "3"

  # External Services
  HYDRA_HOST: "https://regulapiaui.sesapi.pi.gov.br"
