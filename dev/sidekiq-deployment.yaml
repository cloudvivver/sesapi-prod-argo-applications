apiVersion: apps/v1
kind: Deployment
metadata:
  name: sidekiq
  namespace: dev
  labels:
    app: sidekiq
    environment: production
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sidekiq
  template:
    metadata:
      labels:
        app: sidekiq
      annotations:
        kubectl.kubernetes.io/restartedAt: "2025-12-17T11:54:43Z"
    spec:
      containers:
        - name: sidekiq
          image: 961341521437.dkr.ecr.sa-east-1.amazonaws.com/saude-publica-dev:latest
          imagePullPolicy: Always
          command: ["/bin/bash", "-c"]
          args:
            - |
              echo "Aguardando banco de dados..."
              sleep 15

              # Configurar PATH para rbenv
              export PATH="/usr/local/rbenv/shims:/usr/local/rbenv/bin:$PATH"

              echo "Iniciando Sidekiq..."
              bundle exec sidekiq -C config/sidekiq.yml
          envFrom:
            - configMapRef:
                name: env
            - secretRef:
                name: app-secrets
          resources:
            # Otimizado para Sidekiq 6.5 + Ruby 3.0.6 + GC tuning
            # Sidekiq 6 = +30-40% throughput, -50% mem√≥ria, +100% CPU (mais eficiente)
            # Fase 1 (Conservador): concurrency 5 (depois aumentar para 25)
            requests:
              cpu: "100m"        # +100% (era 50m) - Sidekiq 6 usa melhor a CPU
              memory: "256Mi"    # -50% (era 512Mi) - GC + Ruby 3 reduzem heap
            limits:
              cpu: "800m"        # +60% (era 500m) - Mais throughput de jobs
              memory: "768Mi"    # -25% (era 1024Mi) - Limite conservador

      restartPolicy: Always
