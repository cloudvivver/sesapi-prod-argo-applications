apiVersion: apps/v1
kind: Deployment
metadata:
  name: treinamento
  namespace: treinamento
  labels:
    io.kompose.service: treinamento
spec:
  replicas: 2
  selector:
    matchLabels:
      io.kompose.service: treinamento
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
      maxSurge: 1
  minReadySeconds: 180
  template:
    metadata:
      labels:
        io.kompose.service: treinamento
    spec:
      initContainers:
        - name: migrate
          image: 961341521437.dkr.ecr.sa-east-1.amazonaws.com/saude-publica-web:master-74
          command: ["/bin/bash", "-c"]
          args:
            - |
              mkdir -p app/tmp/pids
              mkdir -p app/tmp/sockets
              # Configurar PATH para rbenv
              export PATH="/usr/local/rbenv/shims:/usr/local/rbenv/bin:$PATH"
              bundle exec rake db:migrate
          envFrom:
            - configMapRef:
                name: env
            - secretRef:
                name: app-secrets
        - name: sync-public-assets
          image: 961341521437.dkr.ecr.sa-east-1.amazonaws.com/saude-publica-web:master-74
          command: ["/bin/sh", "-c"]
          args:
            - |
              set -e
              echo "Sincronizando /app/public para volume compartilhado..."
              cp -R /app/public/. /shared-public
          volumeMounts:
            - name: public-assets
              mountPath: /shared-public
      containers:
        - name: treinamento
          image: 961341521437.dkr.ecr.sa-east-1.amazonaws.com/saude-publica-web:master-74
          command: ["/bin/bash", "-c"]
          args:
            - |
              mkdir -p /app/tmp/pids
              mkdir -p /app/tmp/sockets
              # Configurar PATH para rbenv
              export PATH="/usr/local/rbenv/shims:/usr/local/rbenv/bin:$PATH"
              bundle exec puma -C config/puma/production.rb
          ports:
            - containerPort: 3000
          volumeMounts:
            - name: shared-storage
              mountPath: /mnt/compartilhado
            - name: public-assets
              mountPath: /app/public

          envFrom:
            - configMapRef:
                name: env
            - secretRef:
                name: app-secrets
            - secretRef:
                name: c-tv-api-key
                optional: true
          resources:
            requests:
              cpu: "250m"
              memory: "2Gi"
            limits:
              cpu: "500m"
              memory: "4Gi"
        - name: nginx-sidecar
          image: nginx:1.25
          ports:
            - containerPort: 80
          readinessProbe:
            tcpSocket:
              port: 80
            initialDelaySeconds: 10
            periodSeconds: 5
            failureThreshold: 3
          volumeMounts:
            - name: nginx-config
              mountPath: /etc/nginx/nginx.conf
              subPath: nginx.conf
            - name: public-assets
              mountPath: /app/public
            - name: nginx-logs
              mountPath: /var/log/nginx
          resources:
            requests:
              cpu: "50m"
              memory: "64Mi"
            limits:
              cpu: "200m"
              memory: "256Mi"
        - name: nginx-log-processor
          image: alpine:3.19
          command: ["/bin/sh", "-c"]
          args:
            - |
              apk add --no-cache curl jq coreutils openssl

              GATEWAY_URL="http://saude-auditoria-gateway.saude-auditoria-gateway.svc.cluster.local/events"
              APP_HOST="${APP_HOST:-treinamento.saude.pi.gov.br}"
              LOG_FILE="/var/log/nginx/access.log"
              SECRET="${GATEWAY_SECRET:-}"

              echo "Aguardando arquivo de log..."
              while [ ! -f "$LOG_FILE" ]; do sleep 1; done
              echo "Arquivo encontrado: $LOG_FILE"
              echo "Iniciando processamento..."

              tail -f -n +1 "$LOG_FILE" 2>&1 | while IFS='|' read -r method uri status; do
                # Filtrar apenas GETs com status 2xx ou 3xx
                if [ "$method" = "GET" ] && [ "$status" -ge 200 ] && [ "$status" -lt 400 ]; then
                  # Remover query string
                  path="${uri%%\?*}"

                  # Filtrar assets e paths especiais
                  case "$path" in
                    /assets*|/packs*|/health*|/cable*|/rails*|/api/*|*.js|*.css|*.png|*.jpg|*.jpeg|*.gif|*.svg|*.ico)
                      continue
                      ;;
                  esac

                  # Enviar PAGE_VIEW ao gateway
                  json=$(jq -n \
                    --arg type "PAGE_VIEW" \
                    --arg ts "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
                    --arg path "$path" \
                    --arg cluster "$APP_HOST" \
                    '{event_type: $type, timestamp: $ts, caminho: $path, cluster: $cluster}')

                  # Calcular HMAC SHA256 signature se o secret estiver definido
                  if [ -n "$SECRET" ]; then
                    signature=$(echo -n "$json" | openssl dgst -sha256 -hmac "$SECRET" | cut -d' ' -f2)
                    curl -s -X POST "$GATEWAY_URL" \
                      -H "Content-Type: application/json" \
                      -H "X-Audit-Signature: $signature" \
                      -d "$json" > /dev/null 2>&1
                  else
                    curl -s -X POST "$GATEWAY_URL" \
                      -H "Content-Type: application/json" \
                      -d "$json" > /dev/null 2>&1
                  fi
                fi
              done
          env:
            - name: APP_HOST
              valueFrom:
                configMapKeyRef:
                  name: env
                  key: APP_HOST
            - name: GATEWAY_SECRET
              valueFrom:
                secretKeyRef:
                  name: auditoria-gateway-secret-correct
                  key: shared-secret
          volumeMounts:
            - name: nginx-logs
              mountPath: /var/log/nginx
              readOnly: true
          resources:
            requests:
              cpu: "50m"
              memory: "64Mi"
            limits:
              cpu: "200m"
              memory: "256Mi"


      volumes:
        - name: shared-storage
          persistentVolumeClaim:
            claimName: shared-storage-pvc
        - name: nginx-logs
          emptyDir: {}
        - name: nginx-config
          configMap:
            name: nginx-sidecar-pageview-config
        - name: public-assets
          emptyDir: {}
      restartPolicy: Always
