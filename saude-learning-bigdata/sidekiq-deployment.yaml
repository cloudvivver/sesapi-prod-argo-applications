apiVersion: apps/v1
kind: Deployment
metadata:
  name: sidekiq
  labels:
    app: sidekiq
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sidekiq
  template:
    metadata:
      labels:
        app: sidekiq
    spec:
      # ============================================
      # SEGURANÃ‡A: SecurityContext do Pod
      # ============================================
      securityContext:
        runAsUser: 65532  # nonroot user da imagem distroless
        runAsGroup: 65532
        fsGroup: 65532
        runAsNonRoot: true
        seccompProfile:
          type: RuntimeDefault

      containers:
        - name: sidekiq
          image: 961341521437.dkr.ecr.sa-east-1.amazonaws.com/saude-publica-web:master-20
          # Distroless: executar Ruby diretamente (sem shell)
          # Usa bundle exec sidekiq -C config/sidekiq.yml via Ruby
          command: ["/usr/local/rbenv/versions/2.5.0/bin/ruby"]
          args:
            - "-e"
            - "Dir.chdir('/app'); ARGV.replace(['-C', 'config/sidekiq.yml']); require 'bundler/setup'; load Gem.bin_path('sidekiq', 'sidekiq')"
          env:
            - name: RAILS_ENV
              value: "production"
          envFrom:
            - configMapRef:
                name: env
          # SecurityContext do container
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            runAsNonRoot: true
            runAsUser: 65532  # nonroot user da imagem distroless
            capabilities:
              drop:
                - ALL
          resources:
            requests:
              cpu: "100m"
              memory: "2Gi"
            limits:
              cpu: "500m"
              memory: "3Gi"
      restartPolicy: Always
