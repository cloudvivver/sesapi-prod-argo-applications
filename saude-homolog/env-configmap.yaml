apiVersion: v1
data:
  # Application URLs
  RAILS_ENV: production
  APP_BASE_URL: https://homolog.saude.pi.gov.br
  APP_HOST: homolog.saude.pi.gov.br
  REPORT_SERVICE_URL: "https://event-agent.bigdatasys.net/api/events/report"
  WEBSOCKET_NOTIFICATION_URL: "wss://notificacao.bigdatasys.net/ws/relatorios"
  WEBSOCKET_NOTIFICATION_ORIGIN: "saude-devel"

  # Redis Configuration
  REDIS_HOST: redis
  REDIS_PORT: "6379"
  REDIS_DB: "0"
  REDIS_MAXMEMORY_POLICY: "allkeys-lfu"
  REDIS_TIMEOUT: "1"

  # Database Configuration (AWS RDS via Proxy)
  # Sensitive values (username, password) are loaded from app-secrets Secret
  DATABASE_HOST: proxy-db-viverdb.proxy-cb8m6qcy2cyh.sa-east-1.rds.amazonaws.com
  DATABASE_PORT: "5432"
  DATABASE_PROD: saude_devel_pi
  DATABASE_BI_SESAPI: ""

  # Database Connection Pool (optimized for RDS Proxy)
  # RDS Proxy config: max_connections=100%, max_idle=50%, borrow_timeout=120s
  DATABASE_POOL: "20"                      # Max connections per pod
  DATABASE_TIMEOUT: "5000"                 # 5s query timeout
  DATABASE_CHECKOUT_TIMEOUT: "120000"      # 120s checkout timeout (matches RDS Proxy)
  DATABASE_REAPING_FREQUENCY: "60"         # Clean idle connections every 60s
  DATABASE_STATEMENT_LIMIT: "1000"         # Limit prepared statements
  DATABASE_INCLUDES_CACHE: "enabled"

  # Database SSL/TLS (required by RDS Proxy)
  DATABASE_SSLMODE: "require"              # Enforce SSL/TLS connection

  # Rails Application Settings
  RAILS_MAX_THREADS: "6"
  WEB_CONCURRENCY: "2"
  SIDEKIQ_CONCURRENCY: "2"
  RAILS_SERVE_STATIC_FILES: "true"
  RAILS_STATIC_CACHE_CONTROL: "public, max-age=31536000, immutable"

  # Rails Cache Optimizations
  RAILS_ACTION_CACHE: "true"
  RAILS_FRAGMENT_CACHE: "true"
  RAILS_CACHE_STORE: "configured"
  RAILS_CACHE_EXPIRES_IN: "configured"
  RAILS_DESKTOP_CACHE_TTL: "configured"

  # Build Configuration
  BUNDLE_JOBS: "4"
  BUNDLE_RETRY: "3"

  # External Services
  HYDRA_HOST: "https://regulahm.saude.pi.gov.br"

  # Auditoria Gateway (Sistema Cloud-Native de Auditoria)
  AUDITORIA_GATEWAY_URL: "http://saude-auditoria-gateway.saude-auditoria-gateway.svc.cluster.local/events"
  AUDITORIA_GATEWAY_SECRET: "WmkeGRWoHQLxUm2iTsd0wkN43kqnmGGfeGGHbsEPYgg="
  AUDITORIA_API_URL: "http://saude-auditoria-api.saude-auditoria-gateway.svc.cluster.local/api/v1"

  # Report Processing (based on sidekiq CPU limit: 800m = 0.8 cores)
  REPORT_PARALLEL_WORKERS: "2"

kind: ConfigMap
metadata:
  labels:
    io.kompose.service: pgweb-env
  name: env
  namespace: saude-homolog
