---
# KEDA Autoscaling Simples para Airflow
# Este é um exemplo minimalista focado apenas no essencial
#
# Para usar:
# 1. Instale KEDA: ./setup-keda.sh install
# 2. Aplique: kubectl apply -f keda-simple.yaml
# 3. Verifique: kubectl get scaledobject -n saude-airflow

# ==============================================================================
# Autoscaling do Webserver (Recomendado para todos)
# ==============================================================================
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: airflow-webserver
  namespace: saude-airflow
  labels:
    app: airflow
    component: webserver
spec:
  # Deployment que será escalado
  scaleTargetRef:
    name: airflow-webserver
    kind: Deployment

  # Configurações de escala
  minReplicaCount: 2    # Mínimo para alta disponibilidade
  maxReplicaCount: 6    # Máximo para controlar custos

  # Timing
  pollingInterval: 30   # Verificar a cada 30 segundos
  cooldownPeriod: 300   # Aguardar 5 minutos antes de scale down

  # Triggers
  triggers:
    # Escalar quando CPU > 70%
    - type: cpu
      metricType: Utilization
      metadata:
        value: "70"

    # Escalar quando Memory > 80%
    - type: memory
      metricType: Utilization
      metadata:
        value: "80"

---
# ==============================================================================
# Alternativa: HPA Padrão (sem KEDA)
# Use se não puder instalar KEDA
# Descomente abaixo e delete o ScaledObject acima
# ==============================================================================
# apiVersion: autoscaling/v2
# kind: HorizontalPodAutoscaler
# metadata:
#   name: airflow-webserver-hpa
#   namespace: saude-airflow
# spec:
#   scaleTargetRef:
#     apiVersion: apps/v1
#     kind: Deployment
#     name: airflow-webserver
#   minReplicas: 2
#   maxReplicas: 6
#   metrics:
#     - type: Resource
#       resource:
#         name: cpu
#         target:
#           type: Utilization
#           averageUtilization: 70
#     - type: Resource
#       resource:
#         name: memory
#         target:
#           type: Utilization
#           averageUtilization: 80
#   behavior:
#     scaleDown:
#       stabilizationWindowSeconds: 300
#       policies:
#         - type: Percent
#           value: 50
#           periodSeconds: 60
#     scaleUp:
#       stabilizationWindowSeconds: 0
#       policies:
#         - type: Percent
#           value: 100
#           periodSeconds: 60
#         - type: Pods
#           value: 2
#           periodSeconds: 60
#       selectPolicy: Max
